# Phylogenetic Comparative Methods in R: Using phylogeny as a statistical fix #
## Natalie Cooper (ncooper@tcd.ie) ##

### Aims ###
To learn how to use R to answer phylogenetic comparative questions (without panicking!). By the end of this problem set you should be able to:

1. Read in your data and phylogeny
2. Match taxa in your phylogeny with those in your dataset
3. View and manipulate your phylogeny
4. Calculate measures of phylogenetic signal (lambda and K)
5. Perform PGLS analyses using caper
6. Perform a phylogenetic ANOVA using geiger

We will be using the evolution of primate life-history variables as an example. These data come from the PanTHERIA database (Jones *et al*. 2009) and 10kTrees (Arnold *et al*. 2010). Note that this is an old version of 10kTrees, so if you want to use it in your research please download the newest version.

Note that many things in R can be done in multiple ways. You should choose the methods you feel most comfortable with, and do not panic if someone is doing the same analyses as you in a different way! This workshop will be full of different ways to do things.

### Preparations ###

#### Downloading the data and finding the path of your folder ####
First you need to download all the files for this problem set into a folder somewhere on your computer, let’s call it "RAnalyses2014" and pop it on the Desktop. We will use this folder throughout the problem set. You'll need to know what the *path* of the folder is. For example on my Windows machine, the path is:

C:/Users/Natalie/Desktop/RAnalyses2014

The path is really easy to find in a Windows machine, just click on the address bar of the folder and the whole path will appear. 

*IMPORTANT*
In Windows, paths usually include backslashes \ but R can't read these. It's easy to fix in your R code, just change any \ in the path to / or \\. Keep an eye on this throughout the problem set.

On my Mac the path is:

~/Desktop/RAnalyses2014

It's a bit trickier to find the path on a Mac, and note that the tilde ~ is a shorthand for /Users/Natalie.

#### Using a text editor ####
Next, open a text editor. R has an inbuilt editor that works pretty well, but NotePad and TextEdit are fine too. However, in the future I *highly* recommend using something that will highlight code for you. My personal favourite is Sublime Text 2, because you can also use it for any other kind of text editing like LaTeX, html etc. 

You should type (or copy and paste) your code into the text editor, edit it until you think it'll work, and then paste it into R's console window. Saving the text file lets you keep a record of the code you used, which can be a great timesaver if you want to use it again, especially as you know this code will work! 

In this problem set, you'll largely be cutting and pasting. This handout contains pretty much all the R code you need. However, it also sometimes includes the prompts (>) and continuation signs (+). You don't want to paste these into R, so edit them out in your text editor. If you want to add comments to the file (i.e., notes to remind yourself what the code is doing), put a hash/pound sign (#) in front of the comment.

```{r}
# Comments are ignored by R but can remind you what the code is
# doing.
# You need a hash sign at the start of each line of comment.
```

#### Installing packages ####
To run comparative analyses in R, you need to download one or more additional packages from the basic R installation. For this problems set you will need to install the following packages: ape, geiger, picante and caper. To install the package "ape":

```{r, eval = FALSE}
install.packages("ape")
```
Now install geiger, picante and caper.

#### Loading the packages in R ####
You've installed the packages but they don't automatically get loaded into your R session. Instead you need to tell R to load them *every time* you start a new R session and want to use functions from these packages. To load the package ape into your current R session:

```{r, eval = FALSE}
library(ape)
```

Don't forget to load geiger, picante and caper too!

#### Loading the dataset into R ####
Next we need to load the data we are going to use for the analysis. R can read files in lots of formats, including comma-delimited and tab-delimited files. Excel (and many other applications) can output files in this format (it's an option in the "Save As" dialogue box under the "File" menu). To save time I have given you a tab-delimited text file called "Primatedata.txt" which we are going to use. Load these data as follows:

```{r}
primatedata <- read.table("Primatedata.txt", sep = "\t", header = TRUE)
```

Note that sep = "\t" indicates that you have a tab-delimited file, sep = “,” would indicate a comma-delimited csv file. You can also use read.delim for tab delimited files or read.csv for comma delimited files. header = TRUE, indicates that the first line of the data contains column headings.

This is a good point to note that unless you *tell* R you want to do something, it won't do it automatically. So here if you successfully entered the data, R won't give you any indication that it worked. Instead you need to specifically ask R to look at the data.

We can look at the data by typing:

```{r}
str(primatedata)
```
This shows the structure of the data frame (this can be a really useful command when you have a big data file). It also tells you what kind of variables R thinks you have (characters, integers, numeric, factors etc.). Some R functions need the data to be certain kinds of variables so it's useful to check this.

As you can see, the data contains the following variables: Order, Family, Binomial, AdultBodyMass_g, GestationLen_d, HomeRange_km2,   MaxLongevity_m, and SocialGroupSize.

```{r}
head(primatedata)
```
This gives you the first few rows of data along with the column headings.

```{r}
names(primatedata)
```
This gives you the names of the columns.

```{r, eval = FALSE}
primatedata - don't run
```
This will print out the whole of the dataset!

#### Loading and displaying a phylogeny ####
To load a tree you need either the function read.tree or read.nexus. read.tree can deal with a number of different types of data (including DNA) whereas read.nexus reads NEXUS files. We will use a NEXUS file of the consensus tree from 10kTrees. 

primatetree <- read.nexus("consensusTree_10kTrees_Version2.nex") 

Let’s examine the tree by typing:

primatetree
str(primatetree)

primatetree is a fully resolved tree with branch lengths. There are 226 species and 221 internal nodes. We can plot the tree by using the plot function of ape: 

plot(primatetree)

Note that the tree is too large to read. You can make the node labels smaller, but that doesn’t help much here:

plot(primatetree, cex = 0.5)

Alternatively you can zoom into different sections of the tree which you’re interested in:

zoom(primatetree, list(grep("Cercopithecus", primatetree$tip.label)), subtree = FALSE)#just gives you the tree for Cercopithecus species

zoom(primatetree, list(grep("Cercopithecus", primatetree$tip.label)), subtree = TRUE)#just gives you the tree for Cercopithecus species but
#also shows you how it fits into the rest of the tree.

par(mfrow = c(1,1))#this resets the plotting window so it plots only #one thing on it at a time

You can also remove species from the tree very easily using the ape function drop.tip:

primatetree2 <-drop.tip(primatetree, "Aotus_azarae_infulatus")
str(primatetree2)#notice that you now have only 225 tips

To remove more than one species see the Additional Help section at the end of this problem set.

To get further options for the plotting of phylogenies:

?plot.phylo

Note that although you use plot to plot the phylogeney, you need to specify plot.phylo to find out the options for plotting trees. You can change the style of the tree (type), the color of the branches and tips (edge.color, tip.color). Here’s an ugly example! 

par(mfrow = c(1,1))#this resets the plotting window so it plots only #one thing on it at a time

plot(primatetree, type="fan", edge.color="deeppink", tip.color = "green")

You can also add a timescale to your tree:

plot(primatetree)
axisPhylo()

Most R functions require your tree to be dichotomous, i.e. to have no polytomies. To check whether your tree is dichotomous use is.binary.tree. Then use multi2di to make the tree dichotomous. This function works by randomly resolving polytomies with zero length branches.

is.binary.tree(primatetree)#should be TRUE
 
primatetree<-multi2di(primatetree) 

Most functions also require the tree to be rooted, i.e., to have one taxon designated as the outgroup. Our tree is rooted but if you wanted to change the root, or root an unrooted tree:

primatetreereroot<-root(primatetree, "Saimiri_sciureus") #note I just #chose this species at random!
plot(primatetreereroot)
